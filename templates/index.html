<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RFID Reader Control Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      body {
        background: #f6f6f7;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #222;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 380px;
        background: #fff;
        border-right: 1px solid #ececec;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f1f1;
        background: #fafafa;
      }

      .sidebar-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: #222;
        margin: 0;
      }

      .sidebar-content {
        padding: 1.5rem;
        flex: 1;
      }

      .sidebar-section {
        margin-bottom: 2rem;
      }

      .sidebar-section:last-child {
        margin-bottom: 0;
      }

      .section-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #555;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .top-bar {
        background: #fff;
        border-bottom: 1px solid #ececec;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .app-title {
        font-weight: 600;
        font-size: 1.2rem;
        color: #222;
        margin: 0;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e74c3c;
      }

      .status-indicator.status-connected {
        background: #1eae60;
      }

      .content-area {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
      }

      /* Form Controls */
      .form-label {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 0.4rem;
        font-weight: 500;
      }

      .form-control,
      .form-select {
        font-size: 0.9rem;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e0e0e0;
        background: #fff;
        margin-bottom: 1rem;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #222;
        box-shadow: 0 0 0 1px #2221;
      }

      .form-range {
        margin-bottom: 0.5rem;
      }

      .range-value {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 1rem;
      }

      /* Button Styles */
      .btn {
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.15s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
      }

      .btn-primary {
        background: #222;
        color: #fff;
      }

      .btn-primary:hover {
        background: #444;
        color: #fff;
      }

      .btn-success {
        background: #1eae60;
        color: #fff;
      }

      .btn-success:hover {
        background: #17914d;
        color: #fff;
      }

      .btn-warning {
        background: #f39c12;
        color: #fff;
      }

      .btn-warning:hover {
        background: #d68910;
        color: #fff;
      }

      /* Inventory Mode Sections */
      .inventory-mode-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .mode-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .mode-selection {
        margin-bottom: 1rem;
      }

      .mode-controls {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
      }

      /* G2 Mode Parameters */
      .inventory-mode-section .row.g-2 {
        margin-bottom: 1rem;
      }

      .inventory-mode-section .form-control-sm,
      .inventory-mode-section .form-select-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }

      .inventory-mode-section .form-label {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
      }

      .inventory-mode-section .form-check {
        margin-bottom: 0;
      }

      .inventory-mode-section .form-check-label {
        font-size: 0.8rem;
      }

      .mode-controls .btn-group-vertical {
        flex: 1;
      }

      .mode-controls .btn-group {
        flex-shrink: 0;
      }

      .general-controls {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
      }

      .btn-danger {
        background: #e74c3c;
        color: #fff;
      }

      .btn-danger:hover {
        background: #c0392b;
        color: #fff;
      }

      .btn-info {
        background: #3498db;
        color: #fff;
      }

      .btn-info:hover {
        background: #2980b9;
        color: #fff;
      }

      .btn-secondary {
        background: #95a5a6;
        color: #fff;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
        color: #fff;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Button Groups */
      .btn-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .btn-group .btn {
        flex: 1;
        min-width: 80px;
        justify-content: center;
      }

      .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .btn-group-vertical .btn {
        width: 100%;
        justify-content: center;
      }

      /* Cards */
      .card {
        border-radius: 10px;
        border: 1px solid #ececec;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        margin-bottom: 1.5rem;
        background: #fff;
      }

      .card-header {
        background: #fafafa;
        border-bottom: 1px solid #f1f1f1;
        font-weight: 600;
        font-size: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 10px 10px 0 0;
      }

      .card-body {
        padding: 1.25rem;
      }

      /* Stats */
      .stats-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
      }

      .stat-item {
        flex: 1;
        text-align: center;
        padding: 1rem;
        background: #fafafa;
        border-radius: 8px;
      }

      .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #222;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        color: #888;
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Table */
      .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #ececec;
      }

      #tagsTable {
        font-size: 0.9rem;
        margin: 0;
        background: #fff;
      }

      #tagsTable th,
      #tagsTable td {
        padding: 0.75rem;
        vertical-align: middle;
      }

      #tagsTable th {
        background: #f8f8fa;
        font-weight: 600;
        color: #555;
        border-bottom: 1px solid #ececec;
      }

      #tagsTable tbody tr {
        border-bottom: 1px solid #f1f1f1;
      }

      #tagsTable tbody tr:last-child {
        border-bottom: none;
      }

      #tagsTable tbody tr:hover {
        background: #f8f9fa;
      }

      .tag-epc {
        font-family: "JetBrains Mono", "Courier New", monospace;
        font-weight: 500;
        color: #222;
        font-size: 0.85rem;
      }

      .antenna-badge,
      .rssi-badge,
      .phase-badge,
      .freq-badge {
        font-size: 0.8rem;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        font-weight: 500;
      }

      .antenna-badge {
        background: #e9ecef;
        color: #333;
      }

      .rssi-badge {
        background: #f8d7da;
        color: #c0392b;
      }

      .phase-badge {
        background: #d1ecf1;
        color: #0c5460;
      }

      .freq-badge {
        background: #d4edda;
        color: #155724;
      }

      .timestamp {
        color: #888;
        font-size: 0.85rem;
      }

      /* Alerts */
      .alert {
        border-radius: 8px;
        font-size: 0.9rem;
      }

      /* Modal */
      .modal-content {
        border-radius: 12px;
      }

      .modal-header {
        border-bottom: 1px solid #f1f1f1;
        padding: 1.25rem 1.5rem;
      }

      .modal-footer {
        border-top: 1px solid #f1f1f1;
        padding: 1.25rem 1.5rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          max-height: 50vh;
        }

        .stats-row {
          flex-direction: column;
          gap: 1rem;
        }

        .btn-group {
          flex-direction: column;
        }

        .btn-group .btn {
          width: 100%;
        }
      }

      /* Reader Info Styles */
      .reader-info-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
      }

      .info-section {
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
      }

      .info-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .info-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.25rem 1rem;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.125rem 0;
        font-size: 0.8rem;
      }

      .info-item-compact {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.125rem 0;
        font-size: 0.75rem;
        min-height: 1.2rem;
      }

      .info-label {
        font-weight: 500;
        color: #6c757d;
        font-size: 0.85rem;
        min-width: 80px;
        flex-shrink: 0;
      }

      .info-value {
        font-weight: 400;
        color: #212529;
        font-size: 0.85rem;
        text-align: right;
        word-break: break-word;
        flex: 1;
        margin-left: 0.5rem;
      }

      .info-item-compact .info-label {
        font-size: 0.75rem;
        min-width: 80px;
        flex-shrink: 0;
      }

      .info-item-compact .info-value {
        font-size: 0.75rem;
        flex: 1;
        margin-left: 0.5rem;
        text-align: left;
        word-break: break-word;
        line-height: 1.2;
      }

      /* Card Styles */
      .card {
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .card-header {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .card-body {
        padding: 1rem;
      }

      /* Stats Row */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #222;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Table Styles */
      .table {
        margin-bottom: 0;
        font-size: 0.9rem;
      }

      .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.75rem;
      }

      .table td {
        padding: 0.75rem;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
      }

      .table-hover tbody tr:hover {
        background-color: #f8f9fa;
      }

      /* Alert Styles */
      .alert {
        border-radius: 6px;
        border: none;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
      }

      .alert-danger {
        background: #f8d7da;
        color: #721c24;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
      }

      /* Modal Styles */
      .modal-content {
        border-radius: 8px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
      }

      .modal-title {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .modal-body {
        padding: 1.5rem;
      }

      /* Form Check Styles */
      .form-check {
        margin-bottom: 0.5rem;
      }

      .form-check-input:checked {
        background-color: #222;
        border-color: #222;
      }

      .form-check-input:focus {
        border-color: #222;
        box-shadow: 0 0 0 0.2rem rgba(34, 34, 34, 0.25);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .app-container {
          flex-direction: column;
        }

        .main-content {
          height: auto;
        }

        .stats-row {
          grid-template-columns: repeat(2, 1fr);
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .info-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.25rem;
        }

        .info-value {
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h1 class="sidebar-title">
            <i class="fas fa-rfid"></i> RFID Control
          </h1>
        </div>

        <div class="sidebar-content">
          <!-- Connection Section -->
          <div class="sidebar-section">
            <div class="section-title">
              <i class="fas fa-plug"></i> Connection
            </div>

            <label for="portInput" class="form-label">Serial Port</label>
            <input
              type="text"
              class="form-control"
              id="portInput"
              value="/dev/cu.usbserial-10"
              placeholder="Enter serial port"
            />

            <label for="baudrateInput" class="form-label">Baudrate</label>
            <select class="form-select" id="baudrateInput">
              <option value="9600">9600</option>
              <option value="19200">19200</option>
              <option value="38400">38400</option>
              <option value="57600" selected>57600</option>
              <option value="115200">115200</option>
            </select>

            <div class="btn-group">
              <button
                class="btn btn-success"
                id="connectBtn"
                onclick="connect()"
              >
                <i class="fas fa-link"></i> Connect
                <span class="loading" style="display: none">
                  <span class="spinner-border spinner-border-sm"></span>
                </span>
              </button>
              <button
                class="btn btn-danger"
                id="disconnectBtn"
                onclick="disconnect()"
                disabled
              >
                <i class="fas fa-unlink"></i> Disconnect
              </button>
            </div>
          </div>

          <!-- Configuration Section -->
          <div class="sidebar-section">
            <div class="section-title">
              <i class="fas fa-cogs"></i> Configuration
            </div>

            <label for="powerInput" class="form-label">RF Power (dBm)</label>
            <input
              type="range"
              class="form-range"
              id="powerInput"
              min="0"
              max="33"
              value="20"
            />
            <div class="range-value">
              Current: <span id="powerValue">20</span> dBm
            </div>
            <div class="small text-muted mb-2">
              <span id="currentAntennaPower">--</span>
            </div>

            <label for="profileSelect" class="form-label">Profile</label>
            <select class="form-select" id="profileSelect">
              <option value="11">11 - 640kHz, FM0, Tari 7.5μs</option>
              <option value="1">1 - 640kHz, Miller2, Tari 7.5μs</option>
              <option value="15">15 - 640kHz, Miller4, Tari 7.5μs</option>
              <option value="12">12 - 320kHz, Miller2, Tari 15μs</option>
              <option value="3">3 - 320kHz, Miller2, Tari 20μs</option>
              <option value="5">5 - 320kHz, Miller4, Tari 20μs</option>
              <option value="7">7 - 250kHz, Miller4, Tari 20μs</option>
              <option value="13">13 - 160kHz, Miller8, Tari 20μs</option>
            </select>
            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="saveProfile"
                checked
              />
              <label class="form-check-label" for="saveProfile">
                Save to EEPROM
              </label>
            </div>

            <div class="btn-group">
              <button
                class="btn btn-primary"
                onclick="getReaderInfo()"
                id="infoBtn"
                disabled
                title="Get Reader Info"
              >
                <i class="fas fa-info-circle"></i>
              </button>
              <button
                class="btn btn-primary"
                onclick="getAntennaPower()"
                id="powerInfoBtn"
                disabled
                title="Get Power Info"
              >
                <i class="fas fa-bolt"></i>
              </button>
              <button
                class="btn btn-primary"
                onclick="setPower()"
                id="powerBtn"
                disabled
                title="Set Power"
              >
                <i class="fas fa-bolt"></i>
              </button>
              <button
                class="btn btn-primary"
                onclick="setProfile()"
                id="profileBtn"
                disabled
                title="Set Profile"
              >
                <i class="fas fa-save"></i>
              </button>
              <button
                class="btn btn-primary"
                onclick="getProfile()"
                id="getProfileBtn"
                disabled
                title="Get Profile"
              >
                <i class="fas fa-info"></i>
              </button>
            </div>
          </div>

          <!-- Control Section -->
          <div class="sidebar-section">
            <div class="section-title">
              <i class="fas fa-gamepad"></i> Control
            </div>

            <!-- Fast Mode Section -->
            <div class="inventory-mode-section">
              <div class="mode-title">
                <i class="fas fa-bolt"></i> Fast Mode (Start Inventory)
              </div>

              <label for="fastModeTarget" class="form-label">Target</label>
              <select
                class="form-select"
                id="fastModeTarget"
                onchange="updateFastModeButtonText()"
              >
                <option value="0">Target A</option>
                <option value="1">Target B</option>
              </select>

              <div class="mode-controls">
                <div class="btn-group-vertical">
                  <button
                    class="btn btn-primary"
                    onclick="startFastModeInventory()"
                    id="startFastModeBtn"
                    disabled
                  >
                    <i class="fas fa-play"></i> Start Fast Mode
                  </button>

                  <button
                    class="btn btn-warning"
                    onclick="stopFastModeInventory()"
                    id="stopFastModeBtn"
                    disabled
                  >
                    <i class="fas fa-stop"></i> Stop Fast Mode
                  </button>
                </div>

                <div class="btn-group">
                  <button
                    class="btn btn-info"
                    onclick="openFastModeConfigModal()"
                    id="fastModeConfigBtn"
                    disabled
                    title="Fast Mode Config"
                  >
                    <i class="fas fa-sliders-h"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- G2 Mode Section -->
            <div class="inventory-mode-section">
              <div class="mode-title">
                <i class="fas fa-microchip"></i> G2 Mode (Inventory G2)
              </div>

              <label for="g2ModeType" class="form-label">Mode Type</label>
              <div class="mode-selection">
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="g2ModeType"
                    id="g2ModeEPC"
                    value="epc"
                    checked
                  />
                  <label class="form-check-label" for="g2ModeEPC">EPC</label>
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="g2ModeType"
                    id="g2ModeTID"
                    value="tid"
                  />
                  <label class="form-check-label" for="g2ModeTID">TID</label>
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="g2ModeType"
                    id="g2ModeMix"
                    value="mix"
                  />
                  <label class="form-check-label" for="g2ModeMix">Mix</label>
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="g2ModeType"
                    id="g2ModeFastID"
                    value="fastid"
                  />
                  <label class="form-check-label" for="g2ModeFastID"
                    >FastID</label
                  >
                </div>
              </div>

              <!-- G2 Mode Parameters -->
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <label for="g2ScanTime" class="form-label"
                    >Scan Time (s)</label
                  >
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    id="g2ScanTime"
                    value="0"
                    min="0"
                    max="65535"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2QValue" class="form-label">Q Value</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    id="g2QValue"
                    value="4"
                    min="0"
                    max="15"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2Session" class="form-label">Session</label>
                  <select class="form-select form-select-sm" id="g2Session">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="g2Target" class="form-label">Target</label>
                  <select class="form-select form-select-sm" id="g2Target">
                    <option value="0">A</option>
                    <option value="1">B</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="g2TargetTimes" class="form-label"
                    >Target Times</label
                  >
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    id="g2TargetTimes"
                    value="1"
                    min="1"
                    max="255"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2MixMem" class="form-label">Mix Memory</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    id="g2MixMem"
                    value="0"
                    min="0"
                    max="255"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2ReadAddr" class="form-label"
                    >Read Address</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="g2ReadAddr"
                    value="0000"
                    placeholder="0000"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2ReadLen" class="form-label">Read Length</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="g2ReadLen"
                    value="04"
                    placeholder="04"
                  />
                </div>
                <div class="col-md-6">
                  <label for="g2PSD" class="form-label">PSD</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="g2PSD"
                    value="00000000"
                    placeholder="00000000"
                  />
                </div>
                <div class="col-md-6">
                  <div class="form-check mt-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="g2EnablePhase"
                    />
                    <label class="form-check-label" for="g2EnablePhase"
                      >Enable Phase</label
                    >
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check mt-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="g2EnableRate"
                    />
                    <label class="form-check-label" for="g2EnableRate"
                      >Enable Rate</label
                    >
                  </div>
                </div>
              </div>

              <div class="mode-controls">
                <div class="btn-group-vertical">
                  <button
                    class="btn btn-success"
                    onclick="startG2ModeInventory()"
                    id="startG2ModeBtn"
                    disabled
                  >
                    <i class="fas fa-play"></i> Start G2 Mode
                  </button>

                  <button
                    class="btn btn-warning"
                    onclick="stopG2ModeInventory()"
                    id="stopG2ModeBtn"
                    disabled
                  >
                    <i class="fas fa-stop"></i> Stop G2 Mode
                  </button>
                </div>
              </div>
            </div>

            <!-- General Control Buttons -->
            <div class="general-controls">
              <div class="btn-group">
                <button
                  class="btn btn-danger"
                  onclick="clearTags()"
                  title="Clear Tags"
                >
                  <i class="fas fa-trash"></i>
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="resetReader()"
                  title="Reset Reader"
                >
                  <i class="fas fa-redo"></i>
                </button>
                <button
                  class="btn btn-warning"
                  onclick="testSelectCmd()"
                  title="Test Select CMD"
                >
                  <i class="fas fa-vial"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Reader Info Section -->
          <div class="sidebar-section">
            <div class="section-title">
              <i class="fas fa-info-circle"></i> Reader Info
            </div>
            <div id="readerInfo">
              <p class="text-muted" style="font-size: 0.9rem; margin: 0">
                Connect to view reader information
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="top-bar">
          <h2 class="app-title">RFID Reader Control Panel</h2>
          <div class="connection-status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="connectionStatus">Not Connected</span>
          </div>
        </div>

        <div class="content-area">
          <!-- Tags Section -->
          <div class="card">
            <div class="card-header">
              <i class="fas fa-tags"></i> Detected Tags
            </div>
            <div class="card-body">
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-number" id="uniqueTags">0</div>
                  <div class="stat-label">Unique Tags</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="totalTags">0</div>
                  <div class="stat-label">Total Reads</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="timer">00:00:00</div>
                  <div class="stat-label">Timer</div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover" id="tagsTable">
                  <thead>
                    <tr>
                      <th>EPC</th>
                      <th>Count</th>
                      <th>Antenna</th>
                      <th>RSSI (dBm)</th>
                      <th>Phase</th>
                      <th>Freq (kHz)</th>
                      <th>Last Seen</th>
                    </tr>
                  </thead>
                  <tbody id="tagsTableBody">
                    <tr>
                      <td colspan="7" class="text-center text-muted">
                        No tags detected yet
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Parameter Configuration Modal -->
    <div class="modal fade" id="paramConfigModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-sliders-h"></i> Parameter Configuration
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Param1 Section -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Param1 (Q-value, Session, Phase)</h6>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="qValueParam" class="form-label">Q Value</label>
                  <input
                    type="number"
                    class="form-control"
                    id="qValueParam"
                    value="4"
                    min="0"
                    max="15"
                  />
                </div>
                <div class="col-md-4">
                  <label for="sessionParam" class="form-label">Session</label>
                  <select class="form-select" id="sessionParam">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <div class="form-check mt-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="phaseCheck"
                    />
                    <label class="form-check-label" for="phaseCheck"
                      >Phase</label
                    >
                  </div>
                </div>
              </div>
              <div class="form-check mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="saveCheck"
                  checked
                />
                <label class="form-check-label" for="saveCheck"
                  >Save to EEPROM</label
                >
              </div>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="setParam1()">
                  <i class="fas fa-save"></i> Set Param1
                </button>
                <button class="btn btn-info btn-sm" onclick="getParam1()">
                  <i class="fas fa-download"></i> Get Param1
                </button>
              </div>
            </div>

            <!-- TID Parameter Section -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">TID Parameter</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="tidStartAddr" class="form-label"
                    >Start Address</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="tidStartAddr"
                    value="00"
                    placeholder="00"
                  />
                </div>
                <div class="col-md-6">
                  <label for="tidLength" class="form-label">Length</label>
                  <input
                    type="text"
                    class="form-control"
                    id="tidLength"
                    value="04"
                    placeholder="04"
                  />
                </div>
              </div>
              <div class="form-check mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="saveTidCheck"
                  checked
                />
                <label class="form-check-label" for="saveTidCheck"
                  >Save to EEPROM</label
                >
              </div>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="setTidParam()">
                  <i class="fas fa-save"></i> Set TID Param
                </button>
                <button class="btn btn-info btn-sm" onclick="getTidParam()">
                  <i class="fas fa-download"></i> Get TID Param
                </button>
              </div>
            </div>

            <!-- Mask Parameter Section -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Mask Parameter</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Mask Type</label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="maskType"
                      value="0"
                      checked
                    />
                    <label class="form-check-label">EPC (0)</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="maskType"
                      value="1"
                    />
                    <label class="form-check-label">TID (1)</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="maskStartAddr" class="form-label"
                    >Start Address</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="maskStartAddr"
                    value="00"
                    placeholder="00"
                  />
                </div>
                <div class="col-md-6">
                  <label for="maskLength" class="form-label">Length</label>
                  <input
                    type="text"
                    class="form-control"
                    id="maskLength"
                    value="04"
                    placeholder="04"
                  />
                </div>
                <div class="col-md-6">
                  <label for="maskData" class="form-label">Data</label>
                  <input
                    type="text"
                    class="form-control"
                    id="maskData"
                    placeholder="Enter mask data"
                  />
                </div>
              </div>
              <div class="form-check mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="saveMaskCheck"
                  checked
                />
                <label class="form-check-label" for="saveMaskCheck"
                  >Save to EEPROM</label
                >
              </div>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="setMaskParam()">
                  <i class="fas fa-save"></i> Set Mask Param
                </button>
                <button class="btn btn-info btn-sm" onclick="getMaskParam()">
                  <i class="fas fa-download"></i> Get Mask Param
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tags Inventory Modal -->
    <div class="modal fade" id="tagsInventoryModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-cogs"></i> Tags Inventory Configuration
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="qValueInput" class="form-label">Q Value</label>
                <input
                  type="number"
                  class="form-control"
                  id="qValueInput"
                  value="4"
                  min="0"
                  max="15"
                />
              </div>
              <div class="col-md-6">
                <label for="sessionInput" class="form-label">Session</label>
                <select class="form-select" id="sessionInput">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="scanTimeInput" class="form-label"
                  >Scan Time (ms)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="scanTimeInput"
                  value="1000"
                  min="100"
                  max="10000"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="startTagsInventory()"
            >
              <i class="fas fa-play"></i> Start Tags Inventory
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts -->
    <div
      id="alertContainer"
      style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      "
    ></div>
    <script>
      // Socket.IO connection
      const socket = io();
      let isConnected = false;

      // DOM elements
      const statusIndicator = document.getElementById("statusIndicator");
      const connectionStatus = document.getElementById("connectionStatus");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const tagsTableBody = document.getElementById("tagsTableBody");
      const alertContainer = document.getElementById("alertContainer");

      // Tags storage
      let tagsData = new Map(); // Map to store tag data: EPC -> {count, antenna, rssi, lastSeen}

      // Timer logic
      let timerInterval = null;
      let timerStart = null;

      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerStart = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
      }
      function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
      }
      function resetTimer() {
        stopTimer();
        document.getElementById("timer").textContent = "00:00:00";
      }
      function updateTimer() {
        if (!timerStart) return;
        const elapsed = Math.floor((Date.now() - timerStart) / 1000);
        const h = String(Math.floor(elapsed / 3600)).padStart(2, "0");
        const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, "0");
        const s = String(elapsed % 60).padStart(2, "0");
        document.getElementById("timer").textContent = `${h}:${m}:${s}`;
      }

      // Update connection status
      function updateConnectionStatus(connected) {
        isConnected = connected;
        if (connected) {
          statusIndicator.className = "status-indicator status-connected";
          connectionStatus.textContent = "Connected";
          connectBtn.disabled = true;
          connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect';
          disconnectBtn.disabled = false;
          enableControls();
        } else {
          statusIndicator.className = "status-indicator status-disconnected";
          connectionStatus.textContent = "Not Connected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          disableControls();
        }
      }

      // Enable/disable controls
      function enableControls() {
        enableConnectedControls();
      }

      function disableControls() {
        disableConnectedControls();
      }

      // Show alert
      function showAlert(message, type = "info") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        alertContainer.appendChild(alertDiv);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      }

      // API functions
      async function apiCall(url, method = "GET", data = null) {
        try {
          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
          };

          if (data) {
            options.body = JSON.stringify(data);
          }

          const response = await fetch(url, options);
          return await response.json();
        } catch (error) {
          console.error("API Error:", error);
          return { success: false, message: "Network error" };
        }
      }

      // Connect to reader
      async function connect() {
        const port = document.getElementById("portInput").value;
        const baudrate = parseInt(
          document.getElementById("baudrateInput").value
        );

        if (!port) {
          showAlert("Please select a port", "warning");
          return;
        }

        try {
          document.getElementById("connectBtn").disabled = true;
          document.getElementById("connectBtn").innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Connecting...';

          const result = await apiCall("/api/connect", "POST", {
            port: port,
            baudrate: baudrate,
          });

          if (result.success) {
            showAlert(result.message, "success");
            updateConnectionStatus(true);

            // Automatically load reader information after connection (like C# app)
            await getReaderInfo();

            // Enable controls that require connection
            enableConnectedControls();
          } else {
            showAlert(result.message, "danger");
            updateConnectionStatus(false);
          }
        } catch (error) {
          console.error("Connection error:", error);
          showAlert("Connection failed: " + error.message, "danger");
          updateConnectionStatus(false);
        } finally {
          // Only reset the button if connection failed
          if (!isConnected) {
            document.getElementById("connectBtn").disabled = false;
            document.getElementById("connectBtn").innerHTML =
              '<i class="fas fa-plug"></i> Connect';
          }
        }
      }

      // Disconnect from reader
      async function disconnect() {
        try {
          const result = await apiCall("/api/disconnect", "POST");
          if (result.success) {
            showAlert(result.message, "success");
            updateConnectionStatus(false);

            // Clear reader information
            document.getElementById("readerInfo").innerHTML =
              '<p class="text-muted" style="font-size: 0.9rem; margin: 0;">Connect to view reader information</p>';

            // Disable controls that require connection
            disableConnectedControls();
          } else {
            showAlert(result.message, "danger");
          }
        } catch (error) {
          console.error("Disconnect error:", error);
          showAlert("Disconnect failed: " + error.message, "danger");
        }
      }

      // Enable controls that require connection
      function enableConnectedControls() {
        // Enable inventory buttons
        // document.getElementById("startBtn").disabled = false; // General start button not implemented
        document.getElementById("startFastModeBtn").disabled = false;
        document.getElementById("startG2ModeBtn").disabled = false;

        // Enable Fast Mode controls
        document.getElementById("fastModeTarget").disabled = false;

        // Enable configuration buttons
        document.getElementById("fastModeConfigBtn").disabled = false;
        document.getElementById("g2ModeConfigBtn").disabled = false;

        // Enable G2 mode form controls
        document.getElementById("g2ScanTime").disabled = false;
        document.getElementById("g2QValue").disabled = false;
        document.getElementById("g2Session").disabled = false;
        document.getElementById("g2Target").disabled = false;
        document.getElementById("g2TargetTimes").disabled = false;
        document.getElementById("g2MixMem").disabled = false;
        document.getElementById("g2ReadAddr").disabled = false;
        document.getElementById("g2ReadLen").disabled = false;
        document.getElementById("g2PSD").disabled = false;
        document.getElementById("g2EnablePhase").disabled = false;
        document.getElementById("g2EnableRate").disabled = false;

        // Enable power control
        document.getElementById("powerInput").disabled = false;
        document.getElementById("powerBtn").disabled = false;

        // Enable profile control
        document.getElementById("profileSelect").disabled = false;
        document.getElementById("saveProfile").disabled = false;

        // Enable buzzer control
        // document.getElementById("buzzerBtn").disabled = false; // Buzzer button not implemented yet

        // Enable antenna controls
        const antennaCheckboxes = document.querySelectorAll(
          'input[id^="check_ant"]'
        );
        antennaCheckboxes.forEach((checkbox) => {
          checkbox.disabled = false;
        });

        // Enable get reader info button
        document.getElementById("infoBtn").disabled = false;

        // Enable get power info button
        document.getElementById("powerInfoBtn").disabled = false;

        // Enable profile buttons
        document.getElementById("profileBtn").disabled = false;
        document.getElementById("getProfileBtn").disabled = false;
      }

      // Disable controls that require connection
      function disableConnectedControls() {
        // Disable inventory buttons
        // document.getElementById("startBtn").disabled = true; // General start button not implemented
        // document.getElementById("stopBtn").disabled = true; // General stop button not implemented
        document.getElementById("startFastModeBtn").disabled = true;
        document.getElementById("stopFastModeBtn").disabled = true;
        document.getElementById("startG2ModeBtn").disabled = true;
        document.getElementById("stopG2ModeBtn").disabled = true;

        // Disable Fast Mode controls
        document.getElementById("fastModeTarget").disabled = true;

        // Disable configuration buttons
        document.getElementById("fastModeConfigBtn").disabled = true;
        document.getElementById("g2ModeConfigBtn").disabled = true;

        // Disable G2 mode form controls
        document.getElementById("g2ScanTime").disabled = true;
        document.getElementById("g2QValue").disabled = true;
        document.getElementById("g2Session").disabled = true;
        document.getElementById("g2Target").disabled = true;
        document.getElementById("g2TargetTimes").disabled = true;
        document.getElementById("g2MixMem").disabled = true;
        document.getElementById("g2ReadAddr").disabled = true;
        document.getElementById("g2ReadLen").disabled = true;
        document.getElementById("g2PSD").disabled = true;
        document.getElementById("g2EnablePhase").disabled = true;
        document.getElementById("g2EnableRate").disabled = true;

        // Disable power control
        document.getElementById("powerInput").disabled = true;
        document.getElementById("powerBtn").disabled = true;

        // Disable profile control
        document.getElementById("profileSelect").disabled = true;
        document.getElementById("saveProfile").disabled = true;

        // Disable buzzer control
        // document.getElementById("buzzerBtn").disabled = true; // Buzzer button not implemented yet

        // Disable antenna controls
        const antennaCheckboxes = document.querySelectorAll(
          'input[id^="check_ant"]'
        );
        antennaCheckboxes.forEach((checkbox) => {
          checkbox.disabled = true;
        });

        // Disable get reader info button
        document.getElementById("infoBtn").disabled = true;

        // Disable get power info button
        document.getElementById("powerInfoBtn").disabled = true;

        // Disable profile buttons
        document.getElementById("profileBtn").disabled = true;
        document.getElementById("getProfileBtn").disabled = true;
      }

      // Get reader info
      async function getReaderInfo() {
        const result = await apiCall("/api/reader_info");

        if (result.success) {
          const info = result.data;
          console.log("Reader info:", info);

          // Format frequency information
          let freqDisplay = "";
          if (info.frequency_info.band === "Auto") {
            freqDisplay = "Auto Frequency";
          } else {
            freqDisplay = `${info.frequency_info.band_name}<br>`;
            if (info.frequency_info.same_freq) {
              freqDisplay += `Frequency: ${info.frequency_info.min_freq.toFixed(
                3
              )} MHz`;
            } else {
              freqDisplay += `Range: ${info.frequency_info.min_freq.toFixed(
                3
              )} - ${info.frequency_info.max_freq.toFixed(3)} MHz`;
            }
          }

          // Format antenna information
          let antDisplay = "";
          if (info.antenna_config.enabled_antennas.length > 0) {
            antDisplay = `Enabled: ${info.antenna_config.enabled_antennas.join(
              ", "
            )}<br>`;
          }
          antDisplay += `Total: ${info.antenna_count} antennas`;

          // Format output report information
          let outputDisplay = "";
          const outputs = [];
          if (info.output_config.output_rep1) outputs.push("Output 1");
          if (info.output_config.output_rep2) outputs.push("Output 2");
          if (info.output_config.output_rep3) outputs.push("Output 3");
          if (info.output_config.output_rep4) outputs.push("Output 4");
          outputDisplay = outputs.length > 0 ? outputs.join(", ") : "None";

          // Format mode type
          const modeTypes = {
            0: "C6 Series",
            1: "R2000 Series",
            2: "RRUx180 Series",
            3: "9810 Series",
            4: "FD Series",
          };

          document.getElementById("readerInfo").innerHTML = `
            <div class="reader-info-container">
              <!-- Main Info Grid -->
              <div class="info-grid" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <div class="info-item-compact">
                  <span class="info-label">Model:</span>
                  <span class="info-value">${info.model_name}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Type:</span>
                  <span class="info-value">${info.reader_type_hex}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Version:</span>
                  <span class="info-value">${info.version_info}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Address:</span>
                  <span class="info-value">0x${info.com_addr
                    .toString(16)
                    .toUpperCase()}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Power:</span>
                  <span class="info-value">${info.power_dbm} dBm</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Scan Time:</span>
                  <span class="info-value">${info.scan_time} ms</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Antennas:</span>
                  <span class="info-value">${info.antenna_count}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">TR Type:</span>
                  <span class="info-value">${info.tr_type}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Beep:</span>
                  <span class="info-value">${info.beep_status}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Ant Check:</span>
                  <span class="info-value">${info.antenna_check_status}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Ant Config:</span>
                  <span class="info-value">0x${info.ant_cfg0
                    .toString(16)
                    .toUpperCase()}</span>
                </div>
                <div class="info-item-compact">
                  <span class="info-label">Output:</span>
                  <span class="info-value">0x${info.output_rep
                    .toString(16)
                    .toUpperCase()}</span>
                </div>
              </div>
              
              <!-- Frequency Info (if not auto) -->
              ${
                info.frequency_info.band !== "Auto"
                  ? `
              <div class="info-section" style="margin-top: 0.5rem;">
                <h6 class="info-title">Frequency</h6>
                <div class="info-grid" style="grid-template-columns: 1fr; gap: 0.25rem;">
                  <div class="info-item-compact">
                    <span class="info-label">Band:</span>
                    <span class="info-value">${
                      info.frequency_info.band_name
                    }</span>
                  </div>
                  <div class="info-item-compact">
                    <span class="info-label">Range:</span>
                    <span class="info-value">${info.frequency_info.min_freq.toFixed(
                      3
                    )} - ${info.frequency_info.max_freq.toFixed(3)} MHz</span>
                  </div>
                </div>
              </div>
              `
                  : ""
              }
              
              <!-- Antenna Details (if enabled antennas) -->
              ${
                info.antenna_config.enabled_antennas.length > 0
                  ? `
              <div class="info-section" style="margin-top: 0.5rem;">
                <h6 class="info-title">Enabled Antennas</h6>
                <div class="info-item-compact">
                  <span class="info-label">Active:</span>
                  <span class="info-value">${info.antenna_config.enabled_antennas.join(
                    ", "
                  )}</span>
                </div>
              </div>
              `
                  : ""
              }
            </div>
          `;
        } else {
          showAlert(result.message, "warning");
        }
      }

      // Start inventory (commented out - uses non-existent elements)
      /*
      async function startInventory() {
        const target = document.getElementById("targetSelect").value;

        // Stop any existing inventory first
        try {
          await apiCall("/api/stop_inventory", "POST");
          // Wait a bit for the stop to take effect
          await new Promise((resolve) => setTimeout(resolve, 500));
        } catch (error) {
          // Ignore stop errors
        }

        const result = await apiCall("/api/start_inventory", "POST", {
          target: parseInt(target), // Convert to integer
        });

        if (result.success) {
          showAlert(result.message, "success");
          document.getElementById("stopBtn").disabled = false;
          startTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }

      // Stop inventory
      async function stopInventory() {
        const result = await apiCall("/api/stop_inventory", "POST");
        if (result.success) {
          showAlert(result.message, "success");
          stopTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }
      */

      // Fast Mode Inventory Functions
      async function startFastModeInventory() {
        const target = document.getElementById("fastModeTarget").value;

        // Stop any existing inventory first
        try {
          await apiCall("/api/stop_inventory", "POST");
          await new Promise((resolve) => setTimeout(resolve, 500));
        } catch (error) {
          // Ignore stop errors
        }

        const result = await apiCall("/api/start_inventory", "POST", {
          target: parseInt(target),
        });

        if (result.success) {
          showAlert("Fast Mode inventory started successfully", "success");
          document.getElementById("stopFastModeBtn").disabled = false;
          document.getElementById("startFastModeBtn").disabled = true;
          startTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function stopFastModeInventory() {
        const result = await apiCall("/api/stop_inventory", "POST");
        if (result.success) {
          showAlert("Fast Mode inventory stopped", "success");
          document.getElementById("stopFastModeBtn").disabled = true;
          document.getElementById("startFastModeBtn").disabled = false;
          stopTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }

      // G2 Mode Inventory Functions
      async function startG2ModeInventory() {
        const modeType = document.querySelector(
          'input[name="g2ModeType"]:checked'
        ).value;

        // Stop any existing inventory first
        try {
          await apiCall("/api/stop_inventory", "POST");
          await new Promise((resolve) => setTimeout(resolve, 500));
        } catch (error) {
          // Ignore stop errors
        }

        // Get antenna selection (for now, use all antennas)
        const selectedAntennas = [];
        for (let i = 1; i <= 16; i++) {
          const antCheckbox = document.getElementById(`check_ant${i}`);
          if (antCheckbox && antCheckbox.checked) {
            selectedAntennas.push(i);
          }
        }

        // If no antennas selected, use antenna 1 as default
        if (selectedAntennas.length === 0) {
          selectedAntennas.push(1);
        }

        // Get parameters from UI
        const scanTime = parseInt(document.getElementById("g2ScanTime").value);
        const qValue = parseInt(document.getElementById("g2QValue").value);
        const session = parseInt(document.getElementById("g2Session").value);
        const target = parseInt(document.getElementById("g2Target").value);
        const targetTimes = parseInt(
          document.getElementById("g2TargetTimes").value
        );
        const enablePhase = document.getElementById("g2EnablePhase").checked;
        const enableRate = document.getElementById("g2EnableRate").checked;
        const mixMem = parseInt(document.getElementById("g2MixMem").value);
        const readAddr = document.getElementById("g2ReadAddr").value;
        const readLen = document.getElementById("g2ReadLen").value;
        const psd = document.getElementById("g2PSD").value;

        const result = await apiCall("/api/start_inventory_g2", "POST", {
          mode_type: modeType,
          scan_time: scanTime,
          q_value: qValue,
          session: session,
          target: target,
          target_times: targetTimes,
          enable_phase: enablePhase,
          enable_rate: enableRate,
          antennas: selectedAntennas,
          mix_mem: mixMem,
          read_addr: readAddr,
          read_len: readLen,
          psd: psd,
        });

        if (result.success) {
          showAlert("G2 Mode inventory started successfully", "success");
          document.getElementById("stopG2ModeBtn").disabled = false;
          document.getElementById("startG2ModeBtn").disabled = true;
          startTimer();

          // Log the parameters used
          if (result.parameters) {
            console.log("G2 Inventory parameters:", result.parameters);
          }
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function stopG2ModeInventory() {
        const result = await apiCall("/api/stop_inventory_g2", "POST");
        if (result.success) {
          showAlert("G2 Mode inventory stopped", "success");
          document.getElementById("stopG2ModeBtn").disabled = true;
          document.getElementById("startG2ModeBtn").disabled = false;
          stopTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }

      // Config Modal Functions
      function openFastModeConfigModal() {
        // Use the existing parameter configuration modal for Fast Mode
        const modal = new bootstrap.Modal(
          document.getElementById("paramConfigModal")
        );
        modal.show();
      }

      function openG2ModeConfigModal() {
        // TODO: Implement G2 Mode configuration modal
        showAlert("G2 Mode configuration modal - to be implemented", "info");
      }

      // Button text update functions
      function updateFastModeButtonText() {
        const target = document.getElementById("fastModeTarget").value;
        const startBtn = document.getElementById("startFastModeBtn");
        startBtn.innerHTML = `<i class="fas fa-play"></i> Start Fast Mode (Target ${
          target === "0" ? "A" : "B"
        })`;
      }

      // Set power (for single antenna)
      async function setPower() {
        const power = parseInt(document.getElementById("powerInput").value);
        const result = await apiCall("/api/set_power", "POST", {
          power,
        });
        if (result.success) {
          showAlert(result.message, "success");
          document.getElementById(
            "currentAntennaPower"
          ).textContent = `Ant1: ${power}`;
        } else {
          showAlert(result.message, "danger");
        }
      }

      // Get antenna power (for single antenna)
      async function getAntennaPower() {
        const result = await apiCall("/api/get_antenna_power");
        console.log(result);
        if (result.success) {
          const powerLevels = result.data;
          // Build a string like 'Ant1: 20 dBm, Ant2: 20 dBm, ...'
          const powerStr = Object.entries(powerLevels)
            .map(([ant, power]) => `Ant${ant}: ${power}`)
            .join(", ");
          document.getElementById("currentAntennaPower").textContent =
            powerStr || "--";
        } else {
          showAlert(result.message, "warning");
        }
      }

      // Set profile
      async function setProfile() {
        const profileNum = parseInt(
          document.getElementById("profileSelect").value
        );
        const saveOnPowerDown = document.getElementById("saveProfile").checked;

        const result = await apiCall("/api/set_profile", "POST", {
          profile_num: profileNum,
          save_on_power_down: saveOnPowerDown,
        });

        if (result.success) {
          showAlert(result.message, "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      // Get profile
      async function getProfile() {
        const result = await apiCall("/api/get_profile");

        if (result.success) {
          const profile = result.data.profile;
          document.getElementById("profileSelect").value = profile;
          showAlert(`Current profile: ${profile}`, "info");
        } else {
          showAlert(result.message, "warning");
        }
      }

      // Update tags table
      function updateTagsTable() {
        if (tagsData.size === 0) {
          tagsTableBody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">No tags detected yet</td></tr>';
          document.getElementById("uniqueTags").textContent = "0";
          document.getElementById("totalTags").textContent = "0";
          return;
        }

        // Clear table
        tagsTableBody.innerHTML = "";

        // Sort tags by count (descending)
        const sortedTags = Array.from(tagsData.entries()).sort(
          (a, b) => b[1].count - a[1].count
        );

        // Add rows
        sortedTags.forEach(([epc, data]) => {
          const row = document.createElement("tr");

          // Format phase display (show range if different)
          const phaseDisplay =
            data.phase_begin === data.phase_end
              ? data.phase_begin
              : `${data.phase_begin}-${data.phase_end}`;

          // Format frequency display
          const freqDisplay = data.freqkhz > 0 ? data.freqkhz : "-";

          row.innerHTML = `
                    <td><span class="tag-epc">${epc}</span></td>
                    <td><span class="badge bg-primary">${data.count}</span></td>
                    <td><span class="antenna-badge">Ant ${data.antenna}</span></td>
                    <td><span class="rssi-badge">${data.rssi} dBm</span></td>
                    <td><span class="phase-badge">${phaseDisplay}</span></td>
                    <td><span class="freq-badge">${freqDisplay}</span></td>
                    <td><span class="timestamp">${data.lastSeen}</span></td>
                `;
          tagsTableBody.appendChild(row);
        });

        // Update unique tags count
        document.getElementById("uniqueTags").textContent = tagsData.size;

        // Tính lại Total Tags (tổng count)
        let totalCount = 0;
        tagsData.forEach((data) => {
          totalCount += data.count;
        });
        document.getElementById("totalTags").textContent = totalCount;
      }

      // Clear tags
      function clearTags() {
        tagsData.clear();
        updateTagsTable();
        resetTimer();
      }

      // Reset reader
      async function resetReader() {
        try {
          const response = await fetch("/api/reset_reader", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });
          const result = await response.json();
          if (result.success) {
            showAlert(result.message, "success");
            // Clear tags display
            clearTags();
          } else {
            showAlert(result.message, "danger");
          }
        } catch (error) {
          showAlert(`Reset reader error: ${error}`, "danger");
        }
      }

      // Show loading state
      function showLoading(button, loading) {
        const loadingSpan = button.querySelector(".loading");
        const icon = button.querySelector("i");

        if (loading) {
          if (loadingSpan) {
            loadingSpan.style.display = "inline-block";
          }
          if (icon) {
            icon.style.display = "none";
          }
          button.disabled = true;
        } else {
          if (loadingSpan) {
            loadingSpan.style.display = "none";
          }
          if (icon) {
            icon.style.display = "inline-block";
          }
          button.disabled = false;
        }
      }

      // Event listeners
      document
        .getElementById("powerInput")
        .addEventListener("input", function () {
          document.getElementById("powerValue").textContent = this.value;
        });

      // Socket.IO events
      socket.on("connect", function () {
        console.log("🔌 Connected to server via WebSocket");
      });

      socket.on("disconnect", function () {
        console.log("🔌 Disconnected from server");
      });

      socket.on("tag_detected", function (tagData) {
        console.log("🔍 WebSocket tag_detected received:", tagData);

        // Use new RFIDTag structure: epc, antenna, rssi, phase_begin, phase_end, freqkhz
        const epc = tagData.epc || tagData.uid; // Backward compatibility
        const antenna = tagData.antenna || tagData.ant; // Backward compatibility
        const rssi = tagData.rssi || 0;

        if (tagsData.has(epc)) {
          // Update existing tag
          const existing = tagsData.get(epc);
          existing.count++;
          existing.lastSeen = tagData.timestamp;
          // Update RSSI if new one is stronger
          if (rssi > existing.rssi) {
            existing.rssi = rssi;
          }
          // Update antenna if different
          if (existing.antenna !== antenna) {
            existing.antenna = `${existing.antenna}, ${antenna}`;
          }
          // Update phase and frequency data if available (for InventoryMix_G2)
          if (tagData.phase_begin !== undefined) {
            existing.phase_begin = tagData.phase_begin;
            existing.phase_end = tagData.phase_end;
            existing.freqkhz = tagData.freqkhz;
          }
        } else {
          // Add new tag with enhanced data structure
          tagsData.set(epc, {
            count: 1,
            antenna: antenna,
            rssi: rssi,
            lastSeen: tagData.timestamp,
            // New fields for InventoryMix_G2
            phase_begin: tagData.phase_begin || 0,
            phase_end: tagData.phase_end || 0,
            freqkhz: tagData.freqkhz || 0,
            packet_param: tagData.packet_param || 0,
            len: tagData.len || 0,
            device_name: tagData.device_name || "Unknown",
          });
        }

        // Update table display
        updateTagsTable();
      });

      socket.on("status", function (data) {
        console.log("📡 Status message received:", data.message);
      });

      socket.on("connection_status", function (data) {
        updateConnectionStatus(data.connected);
        if (data.message) {
          showAlert(data.message, data.connected ? "success" : "info");
        }
      });

      // Check initial connection status
      async function checkConnectionStatus() {
        try {
          const result = await apiCall("/api/connection_status");
          if (result.success) {
            updateConnectionStatus(result.connected);
          }
        } catch (error) {
          console.log("Could not check connection status:", error);
        }
      }

      // Initialize
      updateConnectionStatus(false);
      // updateStartButtonText(); // Function commented out
      checkConnectionStatus();

      function openTagsInventoryModal() {
        var modal = new bootstrap.Modal(
          document.getElementById("tagsInventoryModal")
        );
        modal.show();
      }

      async function startTagsInventory() {
        const q_value = parseInt(document.getElementById("qValueInput").value);
        const session = parseInt(document.getElementById("sessionInput").value);
        const antenna = 1; // Mặc định sử dụng antenna 1
        const scan_time = parseInt(
          document.getElementById("scanTimeInput").value
        );

        const result = await apiCall("/api/tags_inventory", "POST", {
          q_value,
          session,
          antenna,
          scan_time,
        });
        if (result.success) {
          showAlert(result.message, "success");
          document.getElementById("stopBtn").disabled = false;
          startTimer();
          // Đóng modal
          var modal = bootstrap.Modal.getInstance(
            document.getElementById("tagsInventoryModal")
          );
          modal.hide();
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function stopTagsInventory() {
        const result = await apiCall("/api/stop_tags_inventory", "POST");
        if (result.success) {
          showAlert(result.message, "success");
          document.getElementById("stopBtn").disabled = true;
          stopTimer();
        } else {
          showAlert(result.message, "danger");
        }
      }

      // Parameter Configuration Functions
      function openParamConfigModal() {
        var modal = new bootstrap.Modal(
          document.getElementById("paramConfigModal")
        );
        modal.show();
      }

      async function setParam1() {
        const qValue = parseInt(document.getElementById("qValueParam").value);
        const session = parseInt(document.getElementById("sessionParam").value);
        const phase = document.getElementById("phaseCheck").checked;
        const save = document.getElementById("saveCheck").checked;

        const result = await apiCall("/api/set_param1", "POST", {
          q_value: qValue,
          session: session,
          phase: phase,
          save: save,
        });

        if (result.success) {
          showAlert(result.message, "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function getParam1() {
        const result = await apiCall("/api/get_param1", "GET");
        if (result.success) {
          const data = result.data;
          document.getElementById("qValueParam").value = data.q_value;
          document.getElementById("sessionParam").value = data.session;
          document.getElementById("phaseCheck").checked = data.phase;
          showAlert("Parameter 1 loaded successfully", "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function setTidParam() {
        const startAddr = document.getElementById("tidStartAddr").value;
        const length = document.getElementById("tidLength").value;
        const save = document.getElementById("saveTidCheck").checked;

        const result = await apiCall("/api/set_tid_param", "POST", {
          start_addr: startAddr,
          length: length,
          save: save,
        });

        if (result.success) {
          showAlert(result.message, "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function getTidParam() {
        const result = await apiCall("/api/get_tid_param", "GET");
        if (result.success) {
          const data = result.data;
          document.getElementById("tidStartAddr").value = data.start_addr;
          document.getElementById("tidLength").value = data.length;
          showAlert("TID parameter loaded successfully", "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function setMaskParam() {
        const maskType = document.querySelector(
          'input[name="maskType"]:checked'
        ).value;
        const startAddr = document.getElementById("maskStartAddr").value;
        const length = document.getElementById("maskLength").value;
        const data = document.getElementById("maskData").value;
        const save = document.getElementById("saveMaskCheck").checked;

        const result = await apiCall("/api/set_mask_param", "POST", {
          mask_type: parseInt(maskType),
          start_addr: startAddr,
          length: length,
          data: data,
          save: save,
        });

        if (result.success) {
          showAlert(result.message, "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      async function getMaskParam() {
        const result = await apiCall("/api/get_mask_param", "GET");
        if (result.success) {
          const data = result.data;
          document.querySelector(
            `input[name="maskType"][value="${data.mask_type}"]`
          ).checked = true;
          document.getElementById("maskStartAddr").value = data.start_addr;
          document.getElementById("maskLength").value = data.length;
          document.getElementById("maskData").value = data.data || "";
          showAlert("Mask parameter loaded successfully", "success");
        } else {
          showAlert(result.message, "danger");
        }
      }

      // function updateStartButtonText() {
      //   const targetSelect = document.getElementById("targetSelect");
      //   const startBtn = document.getElementById("startTargetABtn");
      //   const target = targetSelect.value;
      //   startBtn.innerHTML = `<i class="fas fa-play"></i> Start Inventory (Target ${
      //     target === "0" ? "A" : "B"
      //   })`;
      // }

      // Test Select CMD function (commented out - uses non-existent elements)
      /*
      async function testSelectCmd() {
        try {
          const targetSelect = document.getElementById("targetSelect");
          const target = parseInt(targetSelect.value);
          const session = 0; // Default session 0

          console.log(
            `🧪 Testing select_cmd with target=${target}, session=${session}`
          );

          const result = await apiCall("/api/test_select_cmd", "POST", {
            target: target,
            session: session,
          });

          console.log(result);

          if (result.success) {
            console.log("✅ Select CMD test results:", result.results);
            console.log("📋 Parameters used:", result.parameters);

            // Show results in alert
            let message = "Select CMD Test Results:\n\n";
            result.results.forEach((r) => {
              const status =
                r.result === 0 ? "SUCCESS" : `ERROR ${r.result_hex}`;
              message += `Antenna ${r.antenna}: ${status}\n`;
            });

            showAlert(message, "info");
          } else {
            console.error("❌ Select CMD test failed:", result.error);
            showAlert(`Test failed: ${result.error}`, "danger");
          }
        } catch (error) {
          console.error("❌ Select CMD test error:", error);
          showAlert(`Test error: ${error.message}`, "danger");
        }
      }
      */
      // Debug and test functions (commented out - uses non-existent elements)
      /*
      async function debugReader() {
        try {
          console.log("🔍 Debugging reader object...");

          const result = await apiCall("/api/debug_reader", "POST", {});

          if (result.success) {
            console.log("📊 Reader Debug Results:");
            console.log("Reader Type:", result.reader_type);
            console.log("Total Methods:", result.total_methods);
            console.log("Total Attributes:", result.total_attributes);
            console.log("Select Methods:", result.select_methods);
            console.log("All Methods:", result.all_methods);
            console.log("Attributes:", result.attributes);

            // Show results in alert
            let message = `Reader Debug Results:\n\n`;
            message += `Reader Type: ${result.reader_type}\n`;
            message += `Total Methods: ${result.total_methods}\n`;
            message += `Select Methods: ${result.select_methods.join(
              ", "
            )}\n\n`;
            message += `Available Methods:\n${result.all_methods
              .slice(0, 20)
              .join(", ")}`;
            if (result.all_methods.length > 20) {
              message += `\n... and ${result.all_methods.length - 20} more`;
            }

            showAlert(message, "info");
          } else {
            console.error("❌ Reader debug failed:", result.error);
            showAlert(`Debug failed: ${result.error}`, "danger");
          }
        } catch (error) {
          console.error("❌ Reader debug error:", error);
          showAlert(`Debug error: ${error.message}`, "danger");
        }
      }

      async function testSelectCmdFixed() {
        try {
          const targetSelect = document.getElementById("targetSelect");
          const target = parseInt(targetSelect.value);
          const session = 0;

          console.log(
            `🧪 Testing fixed select_cmd with target=${target}, session=${session}`
          );

          const result = await apiCall("/api/test_select_cmd_fixed", "POST", {
            target: target,
            session: session,
          });

          console.log(result);

          if (result.success) {
            console.log("✅ Fixed Select CMD test results:", result.results);

            let message = "Fixed Select CMD Test Results:\n\n";
            result.results.forEach((r) => {
              if (r.success) {
                const status =
                  r.result === 0 ? "SUCCESS" : `ERROR ${r.result_hex}`;
                message += `Antenna ${r.antenna}: ${status}\n`;
              } else {
                message += `Antenna ${r.antenna}: FAILED - ${r.error}\n`;
              }
            });

            showAlert(message, "info");
          } else {
            console.error("❌ Fixed Select CMD test failed:", result.error);
            showAlert(`Test failed: ${result.error}`, "danger");
          }
        } catch (error) {
          console.error("❌ Fixed Select CMD test error:", error);
          showAlert(`Test error: ${error.message}`, "danger");
        }
      }

      async function tryAlternativeSelect() {
        try {
          const targetSelect = document.getElementById("targetSelect");
          const target = parseInt(targetSelect.value);
          const session = 0;

          console.log(`🔄 Trying alternative select methods...`);

          const result = await apiCall("/api/try_alternative_select", "POST", {
            target: target,
            session: session,
          });

          console.log(result);

          if (result.success) {
            console.log("✅ Alternative select test results:", result.results);

            let message = "Alternative Select Method Results:\n\n";
            message += `Available Methods: ${result.available_methods.join(
              ", "
            )}\n\n`;

            result.results.forEach((r) => {
              const status = r.success ? "SUCCESS" : "FAILED";
              message += `${r.method} (${r.parameter_style}): ${status}\n`;
              if (r.error) {
                message += `  Error: ${r.error}\n`;
              }
              if (r.result !== undefined) {
                message += `  Result: ${r.result}\n`;
              }
            });

            showAlert(message, "info");
          } else {
            console.error("❌ Alternative select test failed:", result.error);
            showAlert(`Test failed: ${result.error}`, "danger");
          }
        } catch (error) {
          console.error("❌ Alternative select test error:", error);
          showAlert(`Test error: ${error.message}`, "danger");
        }
      }
      */

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 Initializing RFID Reader Control Panel...");

        // Disable controls initially
        disableConnectedControls();

        // Initialize power slider
        const powerSlider = document.getElementById("powerInput");
        const powerValue = document.getElementById("powerValue");
        if (powerSlider && powerValue) {
          powerSlider.addEventListener("input", function () {
            powerValue.textContent = this.value;
          });
        }

        // Initialize antenna checkboxes
        const antennaCheckboxes = document.querySelectorAll(
          'input[id^="check_ant"]'
        );
        antennaCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            console.log(`Antenna ${this.id} changed to: ${this.checked}`);
          });
        });

        console.log("✅ Initialization complete");
      });
    </script>
  </body>
</html>
